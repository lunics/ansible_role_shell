- block:
  - name: shell | {{ item.name }} | blockinfile > generate exports
    blockinfile:
      path:  "{{ ('/root' if item.owner == 'root' else ('/home/' + item.owner)) + path_exports }}"
      owner: "{{ item
      create: true
      marker: "# {mark} {{ _export.name }}"
      block: |
        {% for export in _export | dict2items(key_name="key", value_name="value") %}
          {%- if export.key != "name" %}
            {%- if export.value | regex_search("\$\(") +%}  {# when item.value start by $(command) then don't add quotes #}
        export {{ export.key }}={{ export.value }}
            {%- else +%}
        export {{ export.key }}="{{ export.value }}"
            {%- endif %}
          {%- endif %}
        {% endfor %}
    #"
    with_subelements:
      - "{{ shell_exports }}"
      - list
      - skip_missing: true

    # loop: #"
    #   - "{{ exports_path   }}"
    #   - "{{ exports_apps   }}"
    #   - "{{ exports_gui    }}"
    #   - "{{ exports_xdg    }}"
    #   - "{{ exports_others }}"
    # loop_control:
    #   loop_var:  _export


  become_user: "{{ item.name }}"
  tags: exports
